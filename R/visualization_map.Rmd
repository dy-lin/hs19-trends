---
title: "visualization_map"
author: "Raissa and Emma"
date: "19/10/2019"
output: 
  html_document:
    toc: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE,message=FALSE)
library(ggplot2)
library(dplyr)
library(plotly)
library(here)
library(ggmap)
library(viridis)
library(rgeos)
library(maptools)
library(maps)
library(sf)
library(readr)
library(tidyverse)
select <- dplyr::select
```


```{r readData}

data <- read_csv(here("data","affiliations_lat_long.csv"))
data <- data %>% 
       select(-X1) %>% distinct() %>%
        drop_na()
# Convert to simple feature object
point_sf <- st_as_sf(data, coords = c("long", "lat"), crs = 4326)

```

# World map showing the number of institutions per country

```{r worldmapdatamanipulation}

# Get world map data
worldmap <- maps::map("world", fill = TRUE, plot = FALSE)

# Convert world to sp class
IDs <- sapply(strsplit(worldmap$names, ":"), "[", 1L)
world_sp <- map2SpatialPolygons(worldmap, IDs = IDs, 
                                proj4string = CRS("+proj=longlat +datum=WGS84"))

# Convert world_sp to simple feature object
world_sf <- st_as_sf(world_sp)

# Add country ID
world_sf <- world_sf %>%
  mutate(region = map_chr(1:length(world_sp@polygons), function(i){
    world_sp@polygons[[i]]@ID
  }))

result <- st_within(point_sf, world_sf, sparse = FALSE)

# Calculate the total count of each polygon
# Store the result as a new column "Count" in world_sf
world_sf <- world_sf %>%
  mutate(Count = apply(result, 2, sum))

# Convert world_sf to a data frame world_df 
world_df <- world_sf
st_geometry(world_df) <- NULL

# Get world data frame
world_data <- map_data("world")

# Merge world_data and world_df
world_data2 <- world_data %>%
  left_join(world_df, by = c("region"))
```

```{r worldmap}
pl <- ggplot() + 
  geom_polygon(data = world_data2, aes(x = long, y = lat, group = group, fill = Count)) +
  #geom_point(data=data,aes(x = long, y = lat),alpha=0.5,size=0.5,colour="grey")+
  coord_fixed(1.3)+
  scale_fill_viridis(breaks=seq(0,300,10))+
  theme_void()

ggplotly(pl)
```

# Map of showing the number of institutions per country

```{r EU Data manipulation}

# Get world map data
worldmap <- maps::map("world", fill = TRUE, plot = FALSE)

# Convert world to sp class
IDs <- sapply(strsplit(worldmap$names, ":"), "[", 1L)
world_sp <- map2SpatialPolygons(worldmap, IDs = IDs, 
                                proj4string = CRS("+proj=longlat +datum=WGS84"))

# Convert world_sp to simple feature object
world_sf <- st_as_sf(world_sp)

# Add country ID
world_sf <- world_sf %>%
  mutate(region = map_chr(1:length(world_sp), function(i){
    world_sp@polygons[[i]]@ID
  }))

###get only europe
data(countryExData)
countryExData <- countryExData %>% filter(grepl("Europe",GEO_subregion))
eumap <- map_data("world") %>% filter(region %in% countryExData$Country)
xmin <- ifelse(min(eumap$long)>180,min(eumap$long)-360,min(eumap$long))
xmax <-  ifelse(max(eumap$long)>180,max(eumap$long)-360,max(eumap$long))
ymin <-  ifelse(min(eumap$lat)>90,min(eumap$lat)-180,min(eumap$lat))
ymax <-  ifelse(max(eumap$lat)>90,max(eumap$lat)-180,max(eumap$lat))

filt_bbox <- sf::st_bbox(c(xmin = -9, 
                           ymin = 36, 
                           xmax = 42.5, 
                           ymax = 70.1), 
                         crs = st_crs(4326)) %>% 
  sf::st_as_sfc(.)


find_data <- sf::st_within(world_sf, filt_bbox)
#> although coordinates are longitude/latitude, st_within assumes that they are planar
europe_sf <- world_sf[which(lengths(find_data) != 0), ]

europe_result <- st_within(point_sf, europe_sf, sparse = FALSE)

# Calculate the total count of each polygon
# Store the result as a new column "Count" in world_sf
europe_sf <- europe_sf %>%
  mutate(Count = apply(europe_result, 2, sum))

# Convert world_sf to a data frame world_df 
europe_df <- europe_sf
st_geometry(europe_df) <- NULL

# Get world data frame
world_data <- map_data("world")

# Merge world_data and world_df
europe_data <- europe_df %>%
  left_join(world_data, by = c("region"))

ind <- sf::st_intersects(point_sf, europe_sf)
points_europe<-  point_sf[which(lengths(ind) != 0), ]
points_europe <- cbind(points_europe,st_coordinates(points_europe))

```

```{r EUmap}
pl <- ggplot() + 
  geom_polygon(data = europe_data, aes(x = long, y = lat, group = group, fill = Count)) +
  geom_point(data=points_europe,aes(x=X,y=Y,text=str_wrap(affiliation,50)),alpha=0.5,size=0.5,colour="grey")+
  coord_fixed(1.3)+
  scale_fill_viridis(breaks=seq(0,80,10))+
  theme_void()

ggplotly(pl)
```

# Map of the USA showing the number of institutions per country


```{r USdataManipulation}
statemap <- maps::map("state", fill = TRUE, plot = FALSE)

# Convert world to sp class
IDs <- sapply(strsplit(statemap$names, ":"), "[", 1L)
state_sp <- map2SpatialPolygons(statemap, IDs = IDs, 
                                proj4string = CRS("+proj=longlat +datum=WGS84"))

# Convert world_sp to simple feature object
state_sf <- st_as_sf(state_sp)

# Add country ID
state_sf <- state_sf %>%
  mutate(region = map_chr(1:length(state_sp@polygons), function(i){
    state_sp@polygons[[i]]@ID
  }))

state_result <- st_within(point_sf, state_sf, sparse = FALSE)

# Calculate the total count of each polygon
# Store the result as a new column "Count" in world_sf
state_sf <- state_sf %>%
  mutate(Count = apply(state_result, 2, sum))

# Convert world_sf to a data frame world_df 
state_df <- state_sf
st_geometry(state_df) <- NULL

# Get world data frame
state_data <- map_data("state")

# Merge world_data and world_df
state_data2 <- state_data %>%
  left_join(state_df, by = c("region"))

points_usa_index <- sf::st_intersects(point_sf, state_sf)
points_usa <-  point_sf[which(lengths(points_usa_index) != 0), ]
points_usa <- cbind(points_usa,st_coordinates(points_usa))

```

```{r usamap}
pl <- ggplot() + 
  geom_polygon(data = state_data2, aes(x = long, y = lat, group = group, fill = Count)) +
  geom_point(data=points_usa,aes(x=X,y=Y,text=str_wrap(affiliation,50)),alpha=0.5,size=0.5,colour="grey")+
  coord_fixed(1.3)+
  scale_fill_viridis(breaks=seq(0,50,10))+
  theme_void()

ggplotly(pl)
```